apiVersion: v1
kind: Namespace
metadata:
  name: garmin-n8n
---
apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: garmin-mariadb
  namespace: garmin-n8n
spec:
  database: garmindb
  image: mariadb:11.4
  passwordSecretKeyRef:
    key: password
    name: garmin-mariadb-credentials
  port: 3306
  replicas: 1
  rootPasswordSecretKeyRef:
    key: password
    name: garmin-mariadb-credentials
  service:
    type: ClusterIP
  storage:
    size: 20Gi
    storageClassName: longhorn
    volumeClaimTemplate:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 20Gi
      storageClassName: longhorn
  username: garmindb
---
apiVersion: batch/v1
kind: Job
metadata:
  name: grant-garmindb-permissions
  namespace: garmin-n8n
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: mysql-client
        image: mariadb:11.4
        command:
        - /bin/bash
        - -c
        - |
          mysql -h garmin-mariadb -u root -p${MARIADB_ROOT_PASSWORD} <<EOF
          GRANT ALL PRIVILEGES ON *.* TO 'garmindb'@'%';
          FLUSH PRIVILEGES;
          EOF
          echo "Permissions granted to garmindb user"
        env:
        - name: MARIADB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: garmin-mariadb-credentials
              key: password

